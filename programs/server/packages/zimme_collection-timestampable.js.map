{"version":3,"file":"/packages/zimme:collection-timestampable.js","sources":["zimme:collection-timestampable/timestampable.coffee"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;AAAA;;KAAK,OAAQ,mBAAb;;EACA,GAAK,OAAQ,sBADb;;EAEA,GAAK,OAAQ,wBAFb;;QAIA,GACE;aAAW,WAAX;EACA,WAAW,WADX;EAEA,WAAW,WAFX;EAGA,WAAW,WAHX;CALF;;SAUA,GAAY,SAAC,OAAD;AAEV;;IAFW,UAAU;GAErB;SACE,CAAC,CAAC,QAAF,CAAW,OAAX,EAAoB,IAAC,QAArB,EAA8B,QAA9B,CADF,EAAC,0BAAD,EAAY,0BAAZ,EAAuB,0BAAvB,EAAkC,0BAAlC;AAGA,MAAG,UAAH;AACE,mBAAe,EAAE,CAAC,YAAlB;IAEA,eAAe;gBACb;cAAM,IAAN;OADa;KAFf;IAKA,YAAY,SAAC,UAAD;aACV,CAAC,CAAC,MAAF,CAAS,UAAT,EAAqB,YAArB,EADU;KALZ;IAQA,eACE;kBAAY,IAAZ;KATF;IAWA,YAAY,SAAC,UAAD;aACV,CAAC,CAAC,MAAF,CAAS,UAAT,EAAqB,YAArB,EADU;KAXZ;IAcA,aAAa,EAdb;AAgBA,QAAG,SAAH;AACE,YAAM,UAAW,WAAX,GACJ;kBAAU,IAAV;QACA,MAAM,IADN;OADF;AAIA,UAAiB,UAAjB;kBAAU,GAAV;OALF;KAhBA;AAuBA,QAAG,SAAH;AACE,YAAM,UAAW,WAAX,GACJ;kBAAU,IAAV;QACA,OAAW,WAAQ,MAAE,YAAY,CAAC,KAAK,CAAC,EAAE,CAAC,MAAxB,GAAgC,OAAxC,CADX;QAEA,MAAM,MAFN;OADF;AAKA,UAAiB,UAAjB;kBAAU,GAAV;OANF;KAvBA;AA+BA,QAAG,SAAH;AACE,YAAM,UAAW,WAAX,GACJ;kBAAU,IAAV;QACA,MAAM,IADN;OADF;AAIA,UAAiB,UAAjB;kBAAU,GAAV;OAJA;AAMA,UAAiB,UAAjB;kBAAU,GAAV;OAPF;KA/BA;AAwCA,QAAG,SAAH;AACE,YAAM,UAAW,WAAX,GACJ;kBAAU,IAAV;QACA,OAAW,WAAQ,MAAE,YAAY,CAAC,KAAK,CAAC,EAAE,CAAC,MAAxB,GAAgC,OAAxC,CADX;QAEA,MAAM,MAFN;OADF;AAKA,UAAiB,UAAjB;kBAAU,GAAV;OALA;AAOA,UAAiB,UAAjB;kBAAU,GAAV;OARF;KAxCA;IAkDA,IAAC,WAAU,CAAC,YAAZ,CAA6B,iBAAa,UAAb,CAA7B,CAlDA,CADF;GAHA;EAwDA,oBAAoB,IAAC,WAAU,CAAC,WAAZ,KAA2B,IAxD/C;AA0DA,MAAG,MAAM,CAAC,QAAP,IAAmB,iBAAtB;AACE,QAAC,WAAU,CAAC,MAAM,CAAC,MAAnB,CAA0B,SAAC,MAAD,EAAe,GAAf;;QAAC,SAAS;OAClC;UAAG,SAAH;AACE,WAAI,WAAJ,GAAiB,QAAjB,CADF;;AAEA,UAAG,aAAkB,wBAArB;eACE,GAAI,WAAJ,GAAiB,OADnB;OAHwB;KAA1B;WAMA,IAAC,WAAU,CAAC,MAAM,CAAC,MAAnB,CAA0B,SAAC,MAAD,EAAe,GAAf,EAAoB,UAApB,EAAgC,QAAhC,EACxB,OADwB;AAGxB;;QAHyB,SAAS;OAGlC;qCAAO,QAAQ,CAAC,OAAT,QAAQ,CAAC,OAAQ,EAAxB;AAEA,UAAG,SAAH;AACE,YAAK,WAAL,GAAkB,QAAlB,CADF;OAFA;AAIA,UAAG,aAAkB,wBAArB;eACE,IAAK,WAAL,GAAkB,OADpB;OAPwB;KAA1B,EAPF;GA5DU;CAVZ;;oBAuFoB,CAAC,MAArB,CAA4B,eAA5B,EAA6C,SAA7C,CAvFA;A","sourcesContent":["af = Package['aldeed:autoform']\nc2 = Package['aldeed:collection2']\nss = Package['aldeed:simple-schema']\n\ndefaults =\n  createdAt: 'createdAt'\n  createdBy: 'createdBy'\n  updatedAt: 'updatedAt'\n  updatedBy: 'updatedBy'\n\nbehaviour = (options = {}) ->\n\n  {createdAt, createdBy, updatedAt, updatedBy} =\n    _.defaults options, @options, defaults\n\n  if ss?\n    SimpleSchema = ss.SimpleSchema\n\n    afDefinition = autoform:\n      omit: true\n\n    addAfDefs = (definition) ->\n      _.extend definition, afDefinition\n\n    c2Definition =\n      denyInsert: true\n\n    addC2Defs = (definition) ->\n      _.extend definition, c2Definition\n\n    definition = {}\n\n    if createdAt\n      def = definition[createdAt] =\n        optional: true\n        type: Date\n\n      addAfDefs def if af?\n\n    if createdBy\n      def = definition[createdBy] =\n        optional: true\n        regEx: new RegExp \"(#{SimpleSchema.RegEx.Id.source})|^0$\"\n        type: String\n\n      addAfDefs def if af?\n\n    if updatedAt\n      def = definition[updatedAt] =\n        optional: true\n        type: Date\n\n      addAfDefs def if af?\n\n      addC2Defs def if c2?\n\n    if updatedBy\n      def = definition[updatedBy] =\n        optional: true\n        regEx: new RegExp \"(#{SimpleSchema.RegEx.Id.source})|^0$\"\n        type: String\n\n      addAfDefs def if af?\n\n      addC2Defs def if c2?\n\n    @collection.attachSchema new SimpleSchema definition\n\n  isLocalCollection = @collection._connection is null\n\n  if Meteor.isServer or isLocalCollection\n    @collection.before.insert (userId = '0', doc) ->\n      if createdAt\n        doc[createdAt] = new Date\n      if createdBy and not doc[createdBy]?\n        doc[createdBy] = userId\n\n    @collection.before.update (userId = '0', doc, fieldNames, modifier,\n      options) ->\n\n      $set = modifier.$set ?= {}\n\n      if updatedAt\n        $set[updatedAt] = new Date\n      if updatedBy and not doc[updatedBy]?\n        $set[updatedBy] = userId\n\nCollectionBehaviours.define 'timestampable', behaviour\n"]}