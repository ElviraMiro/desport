{"version":3,"file":"/packages/edgee:meteor-server-deps.js","sources":["edgee:meteor-server-deps/lib/server-deps.coffee"],"names":[],"mappings":"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","sourcesContent":["# External code can't access this, and so won't be able to directly construct a Deps.Computation instance\r\nprivateObj = {}\r\nnextId = 1\r\nafterFlushCallbacks = []\r\nqueue = new Meteor._SynchronousQueue()\r\n\r\nDeps = _.extend Tracker,\r\n\tcurrentComputationVar: new Meteor.EnvironmentVariable()\r\n\t\r\n\tflush: ->\r\n\t\tif not queue.safeToRunTask()\r\n\t\t\tthrow new Error(\"Can't call Deps.flush while flushing, or inside Deps.autorun\")\r\n\t\t\r\n\t\tqueue.drain()\r\n\t\t\t\r\n\t_postRun: ->\r\n\t\twhile (queue._taskHandles.length == 0) and (afterFlushCallbacks.length > 0)\r\n\t\t\tf = afterFlushCallbacks.shift()\r\n\t\t\ttry\r\n\t\t\t\tf()\r\n\t\t\tcatch e\r\n\t\t\t\tconsole.log \"Exception from Deps afterFlush function:\", e.stack || e.message\r\n\t\r\n\tautorun: (f) ->\r\n\t\tc = new Deps.Computation(f, Deps.currentComputation, privateObj)\r\n\t\t\r\n\t\tif Deps.active\r\n\t\t\tDeps.onInvalidate -> c.stop()\r\n\t\t\t\r\n\t\tc\r\n\t\r\n\tnonreactive: (f) ->\r\n\t\tDeps.currentComputationVar.withValue null, f\r\n\t\r\n\t_makeNonreactive: (f) ->\r\n\t\tif f.$isNonreactive\r\n\t\t\treturn f\r\n\t\tresult = (args...) ->\r\n\t\t\tDeps.nonreactive =>\r\n\t\t\t\tf.apply(@, args)\r\n\t\tresult.$isNonreactive = true\r\n\t\tresult\r\n\t\r\n\tonInvalidate: (f) ->\r\n\t\tif not Deps.active\r\n\t\t\tthrow new Error(\"Deps.onInvalidate requires a currentComputation\")\r\n\t\t\t\r\n\t\tDeps.currentComputation.onInvalidate(f)\r\n\t\t\r\n\tafterFlush: (f) ->\r\n\t\tafterFlushCallbacks.push(f)\r\n\r\n# Compatibility with client-side Deps\r\nObject.defineProperties Deps,\r\n\tcurrentComputation:\r\n\t\tget: ->\r\n\t\t\tDeps.currentComputationVar.get()\r\n\tactive:\r\n\t\tget: ->\r\n\t\t\t!!Deps.currentComputationVar.get()\r\n\r\nclass Deps.Computation\r\n\tconstructor: (f, @_parent, p)->\r\n\t\tif p != privateObj\r\n\t\t\tthrow new Error(\"Deps.Computation constructor is private; use Deps.autorun\")\r\n\t\t\r\n\t\t@stopped = false\r\n\t\t@invalidated = false\r\n\t\t@firstRun = true\r\n\t\t@_id = nextId++\r\n\t\t@_onInvalidateCallbacks = []\r\n\t\t@_recomputing = false\r\n\t\t\r\n\t\tDeps.currentComputationVar.withValue @, =>\r\n\t\t\t@_func = Meteor.bindEnvironment(f, null, @)\r\n\t\t\r\n\t\terrored = true\r\n\t\ttry\r\n\t\t\t@._compute()\r\n\t\t\terrored = false\r\n\t\tfinally\r\n\t\t\t@firstRun = false\r\n\t\t\tif errored\r\n\t\t\t\t@stop()\r\n\t\r\n\tonInvalidate: (f) ->\r\n\t\tif typeof f != \"function\"\r\n\t\t\tthrow new Error(\"onInvalidate requires a function\")\r\n\t\t\r\n\t\tf = Deps._makeNonreactive(Meteor.bindEnvironment(f, null, @))\r\n\t\t\r\n\t\tif @invalidated\r\n\t\t\tf()\r\n\t\telse\r\n\t\t\t@_onInvalidateCallbacks.push(f)\r\n\t\t\r\n\tinvalidate: ->\r\n\t\tif not @invalidated\r\n\t\t\tif not @_recomputing and not @stopped\r\n\t\t\t\tqueue.queueTask =>\r\n\t\t\t\t\t@._recompute()\r\n\t\t\t\t\tDeps._postRun()\r\n\t\t\t\r\n\t\t\t@invalidated = true\r\n\t\t\t\r\n\t\t\tfor callback in @_onInvalidateCallbacks\r\n\t\t\t\tcallback()\r\n\t\t\t@_onInvalidateCallbacks = []\r\n\t\r\n\tstop: ->\r\n\t\tif not @stopped\r\n\t\t\t@stopped = true\r\n\t\t\t@invalidate()\r\n\t\t\t\r\n\t_compute: ->\r\n\t\t@invalidated = false\r\n\t\t@._func(@)\r\n\t\t\r\n\t_recompute: ->\r\n\t\t@_recomputing = true\r\n\t\twhile @invalidated and not @stopped\r\n\t\t\ttry\r\n\t\t\t\t@._compute()\r\n\t\t\tcatch e\r\n\t\t\t\tconsole.log e\r\n\t\t@_recomputing = false\r\n\t\t\r\nclass Deps.Dependency\r\n\tconstructor: ->\r\n\t\t@_dependentsById = {}\r\n\t\r\n\tdepend: (computation = Deps.currentComputation) ->\r\n\t\tif not computation\r\n\t\t\treturn false\r\n\t\t\r\n\t\tid = computation._id\r\n\t\t\r\n\t\tif not (id of @_dependentsById)\r\n\t\t\t@_dependentsById[id] = computation\r\n\t\t\tcomputation.onInvalidate =>\r\n\t\t\t\tdelete @_dependentsById[id]\r\n\t\t\t\r\n\t\t\treturn true\r\n\t\tfalse\r\n\t\t\r\n\tchanged: ->\r\n\t\tfor id, computation of @_dependentsById\r\n\t\t\tcomputation.invalidate()\r\n\t\t\r\n\thasDependents: ->\r\n\t\tfor id, computation of @_dependentsById\r\n\t\t\treturn true\r\n\t\tfalse\r\n\t\t\r\n"]}