{"version":3,"file":"/packages/edgee:meteor-reactive-publish.js","sources":["edgee:meteor-reactive-publish/lib/reactive-publish.coffee"],"names":[],"mappings":"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","sourcesContent":["override = (obj, dict) ->\r\n\tresult = {}\r\n\r\n\tfor key of dict\r\n\t\tdo (key) ->\r\n\t\t\timpl = dict[key]\r\n\t\t\t\r\n\t\t\toldImpl = obj[key]\r\n\t\t\tobj[key] = impl\r\n\r\n\t\t\tresult[key] = (args2...) -> oldImpl.call(args2...)\r\n\t\r\n\tresult\r\n\r\nCursor = Object.getPrototypeOf(Meteor.users.find {_id: null}).constructor\r\nparent = override Cursor.prototype,\r\n\tobserveChanges: (callbacks) ->\r\n\t\thandle = Deps.nonreactive => parent.observeChanges(@, callbacks)\r\n\t\tif Deps.active and @._cursorDescription.options.reactive\r\n\t\t\tDeps.onInvalidate ->\r\n\t\t\t\thandle.stop()\r\n\t\thandle\r\n\t\t\r\n\t_depend: (changers) ->\r\n\t\tif Deps.active\r\n\t\t\tv = new Deps.Dependency\r\n\t\t\tv.depend()\r\n\t\t\tready = false\r\n\t\t\t\r\n\t\t\tnotifyChange = Meteor.bindEnvironment ->\r\n\t\t\t\tif ready\r\n\t\t\t\t\tv.changed()\r\n\r\n\t\t\toptions = {}\r\n\t\t\t_.each ['added', 'changed', 'removed', 'addedBefore', 'movedBefore'], (fnName) =>\r\n\t\t\t\tif changers[fnName]\r\n\t\t\t\t\toptions[fnName] = notifyChange\r\n\r\n\t\t\t@observeChanges(options)\r\n\t\t\t\r\n\t\t\tready = true\r\n\r\n\tforEach: (args...) ->\r\n\t\tif @._cursorDescription.options.reactive\r\n\t\t\t@._depend {added: true, changed: true, removed: true}\r\n\t\tparent.forEach @, args...\r\n\t\t\r\n\tmap: (args...) ->\r\n\t\tif @._cursorDescription.options.reactive\r\n\t\t\t@._depend {added: true, changed: true, removed: true}\r\n\t\tparent.map @, args...\r\n\t\t\r\n\tfetch: (args...) ->\r\n\t\tif @._cursorDescription.options.reactive\r\n\t\t\t@._depend {added: true, changed: true, removed: true}\r\n\t\tparent.fetch @, args...\r\n\t\t\r\n\tcount: (args...) ->\r\n\t\tif @._cursorDescription.options.reactive\r\n\t\t\t@._depend {added: true, removed: true}\r\n\t\tparent.count @, args...\r\n\t\t\r\nMeteor.reactivePublish = (name, f) ->\r\n\tMeteor.publish name, (args...) ->\r\n\t\toldRecords = {}\r\n\t\tdepends = []\r\n\t\tisPublishing = false\r\n\t\t\r\n\t\thandle = Deps.autorun =>\r\n\t\t\tnewRecords = {}\r\n\t\t\t\r\n\t\t\taddCursor = (cursor) =>\r\n\t\t\t\tif cursor\r\n\t\t\t\t\tcollectionName = cursor._cursorDescription.collectionName\r\n\t\t\t\t\r\n\t\t\t\t\trecord =\r\n\t\t\t\t\t\tcursor: cursor\r\n\t\t\t\t\t\tids: {}\r\n\t\t\t\t\t\r\n\t\t\t\t\tnewRecords[collectionName] = record\r\n\t\t\t\t\toldRecord = oldRecords[collectionName] ? {ids: {}}\r\n\t\t\t\t\t\r\n\t\t\t\t\tcursor.observeChanges\r\n\t\t\t\t\t\tadded: (id, fields) =>\r\n\t\t\t\t\t\t\trecord.ids[id] = true\r\n\t\t\t\t\t\t\tif id of oldRecord.ids\r\n\t\t\t\t\t\t\t\tdelete oldRecord.ids[id]\r\n\t\t\t\t\t\t\telse\r\n\t\t\t\t\t\t\t\t@added(collectionName, id, fields)\r\n\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\tremoved: (id) =>\r\n\t\t\t\t\t\t\tif id in _.keys(record.ids)\r\n\t\t\t\t\t\t\t\tdelete record.ids[id]\r\n\t\t\t\t\t\t\t\t@removed(collectionName, id)\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\tchanged: (id, fields) =>\r\n\t\t\t\t\t\t\t@changed(collectionName, id, fields)\r\n\t\t\t\r\n\t\t\tresult = f.call(@, args...)\r\n\t\t\t\r\n\t\t\tif _.isArray(result)\r\n\t\t\t\tfor cursor in result\r\n\t\t\t\t\taddCursor cursor\r\n\t\t\telse\r\n\t\t\t\taddCursor result\r\n\t\t\t\r\n\t\t\tfor collectionName, record of oldRecords\r\n\t\t\t\tfor id of record.ids\r\n\t\t\t\t\t@removed(collectionName, id)\r\n\t\t\t\trecord.ids = {}\r\n\t\t\t\r\n\t\t\toldRecords = newRecords\r\n\t\t\t\r\n\t\t@onStop =>\r\n\t\t\thandle.stop()\r\n\t\t\r\n\t\t@ready()\r\n\t\treturn\r\n\t\t"]}